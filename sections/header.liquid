<section class="section search-section" id="search" aria-labelledby="search-label">

  <div class="container">
    <p class="section-subtitle" id="search-label">{{ section.settings.subtitle }}</p>
    
    <div class="search-wrapper">
      <div class="search-input-wrapper">
        <input 
          type="search" 
          id="main-search-input"
          placeholder="{{ section.settings.placeholder }}" 
          class="search-input"
          aria-label="Search products"
        >
        <button type="button" class="search-btn" aria-label="Search" id="search-submit-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
      </div>
      
      <div id="main-search-results" class="search-results-dropdown"></div>
    </div>
  </div>

</section>

<script>
(function() {
  const searchInput = document.getElementById('main-search-input');
  const searchResults = document.getElementById('main-search-results');
  const searchBtn = document.getElementById('search-submit-btn');

  function debounce(func, delay) {
    let timeout;
    return function() {
      const context = this;
      const args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(context, args), delay);
    };
  }

  function performSearch() {
    const query = searchInput.value.trim();

    if (query.length > 2) {
      fetch(`/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product`)
        .then(response => response.json())
        .then(data => {
          const results = data.resources.results.products;
          let resultsHTML = '';

          if (results.length) {
            results.forEach(product => {
              const price = product.price ? (product.price / 100).toFixed(2) : 'N/A';
              resultsHTML += `
                <div class="search-result-item">
                  <a href="${product.url}">
                    <img src="${product.image}" alt="${product.title}">
                    <div>
                      <p class="product-title">${product.title}</p>
                      <p class="product-price">{{ cart.currency.symbol }}${price}</p>
                    </div>
                  </a>
                </div>
              `;
            });
          } else {
            resultsHTML = '<p class="no-results">No products found</p>';
          }

          searchResults.innerHTML = resultsHTML;
          searchResults.classList.add('active');
        })
        .catch(error => {
          console.error('Error fetching search results:', error);
          searchResults.innerHTML = '<p class="error-message">There was an error retrieving search results.</p>';
          searchResults.classList.add('active');
        });
    } else {
      searchResults.innerHTML = '';
      searchResults.classList.remove('active');
    }
  }

  // Debounced search on input
  searchInput.addEventListener('input', debounce(performSearch, 300));

  // Search on button click
  searchBtn.addEventListener('click', function(e) {
    e.preventDefault();
    performSearch();
  });

  // Search on Enter key
  searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      performSearch();
    }
  });

  // Close search results when clicking outside
  document.addEventListener('click', function(event) {
    if (!searchResults.contains(event.target) && !searchInput.contains(event.target) && !searchBtn.contains(event.target)) {
      searchResults.classList.remove('active');
    }
  });

  // Close search results on scroll
  document.addEventListener('scroll', function() {
    searchResults.classList.remove('active');
  });
})();
</script>

<style>
.search-section { 
  padding-inline: 15px;
  padding-block: 60px;
}

.search-section .section-subtitle {
  padding-inline: 10px;
  margin-block-end: 40px;
  font-size: var(--fs-5);
  font-weight: var(--fw-500);
  text-align: center;
}

.search-wrapper {
  max-width: 800px;
  margin: 0 auto;
  position: relative;
}

.search-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  border: 1px solid black;
  padding: 15px 20px;
  background-color: var(--white);
  transition: var(--transition-2);
}

.search-input-wrapper:focus-within {
  border-color: gray;
}

.search-input {
  flex: 1;
  border: none;
  outline: none;
  font-size: var(--fs-7);
  font-family: inherit;
  background: transparent;
}

.search-input::placeholder {
  font-size: 14px;
  color: #999;
}

.search-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition-2);
}

.search-btn:hover {
  opacity: 0.7;
}

.search-results-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 5px);
  left: 0;
  width: 100%;
  background-color: white;
  border: 1px solid black;
  z-index: 1000;
  max-height: 400px;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.search-results-dropdown.active {
  display: block;
}

.search-result-item {
  padding: 15px;
  border-bottom: 1px solid #eee;
  transition: var(--transition-2);
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-item:hover {
  background-color: #f9f9f9;
}

.search-result-item a {
  display: flex;
  align-items: center;
  gap: 15px;
  text-decoration: none;
  color: inherit;
}

.search-result-item img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  flex-shrink: 0;
}

.search-result-item .product-title {
  font-size: 14px;
  font-weight: var(--fw-500);
  margin: 0 0 5px 0;
  color: black;
}

.search-result-item .product-price {
  font-size: 13px;
  color: #666;
  margin: 0;
}

.no-results,
.error-message {
  padding: 20px;
  text-align: center;
  font-size: 14px;
  color: #666;
}

.error-message {
  color: #d32f2f;
}

@media (min-width: 768px) {
  .search-input-wrapper {
    padding: 20px 30px;
  }

  .search-input {
    font-size: 16px;
  }

  .search-result-item img {
    width: 80px;
    height: 80px;
  }

  .search-result-item .product-title {
    font-size: 16px;
  }

  .search-result-item .product-price {
    font-size: 14px;
  }
}

@media (min-width: 992px) {
  .search-section {
    padding-block: 80px;
  }

  .search-results-dropdown {
    max-height: 500px;
  }
}

@media (min-width: 1200px) {
  .search-input {
    font-size: 18px;
  }

  .search-input::placeholder {
    font-size: 16px;
  }

  .search-wrapper {
    max-width: 1000px;
  }
}

@media (min-width: 1400px) {
  .search-section { 
    padding-inline: 70px;
  }
}
</style>

{% schema %}
{
  "name": "Search Page",
  "settings": [
    {
      "type": "text",
      "id": "subtitle",
      "label": "Section Subtitle",
      "default": "Search Our Collection"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Search Placeholder",
      "default": "Search for perfumes, collections..."
    }
  ],
  "blocks": [],
  "presets": [
    {
      "name": "Search Page"
    }
  ]
}
{% endschema %}